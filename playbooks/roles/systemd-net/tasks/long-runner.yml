---
# Create a long running service just intended to ensure the docker
# storage filesystems are in use at shutdown time (for testing the
# shutdown ordering)

# - name: check for existing image
#   shell: docker images | grep -q busybox
#   register: current_image

# # Docker pill print "Downloaded newer" or "Image is up to date"
# - name: Pre-pull the image
#   command:  docker pull busybox:latest
#   register: pull_result
#   when:  not current_image.stdout | search('busybox')
#   changed_when: pull_result|search('Downloaded newer')

- name: Prepare busyboxy image
  docker_image: name=busybox:latest

- name: Install script
  copy: src={{item}} mode=0755 dest=/root
  register: scripts
  with_items:
    - long-runner.sh

- name: Install systemd unit
  copy: src={{item}} mode=0644 dest=/etc/systemd/system
  register: services
  with_items:
    - long-runner.service
    - docker-stopped.service

- name: Enable and start
  systemd: name={{item}} daemon_reload=yes state=started enabled=yes
  when: services.changed or scripts.changed
  with_items:
    - long-runner.service
    - docker-stopped.service
